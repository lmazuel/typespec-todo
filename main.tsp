import "@typespec/http";
import "@typespec/rest";
import "@typespec/openapi3";
import "@typespec/openapi";

using Http;

@service({
  title: "Todo App",
})
@useAuth(BearerAuth)
namespace Todo;

model User {
  /** An autogenerated unique id for the user */
  @key
  @visibility("read")
  id: safeint;

  /** The user's username */
  @maxLength(50)
  username: string;

  /** The user's email address */
  //@format("email")
  email: string;

  /**
   * The user's password, provided when creating a user
   * but is otherwise not visible (and hashed by the backend)
   */
  @visibility("create")
  password: string;
}

model TodoItem {
  /** The item's unique id */
  @key id: safeint;

  /** The item's title */
  @maxLength(255)
  title: string;

  /** User that created the todo */
  @visibility("read") createdBy: User.id;

  /** User that the todo is assigned to */
  assignedTo?: User.id;

  /** A longer description of the todo item in markdown format */
  description?: string;

  /** The status of the todo item */
  status: "NotStarted" | "InProgress" | "Completed";

  /** When the todo item was created. */
  @visibility("read") createdAt: utcDateTime;

  /** When the todo item was last updated */
  @visibility("read") updatedAt: utcDateTime;

  /** When the todo item was makred as completed */
  @visibility("read") completedAt: utcDateTime;

  // Want the read form to be normalized to TodoLabelRecord[], but can't
  // https://github.com/microsoft/typespec/issues/2926
  labels: TodoLabel[];
}

union TodoLabel {
  string,
  string[],
  TodoLabelRecord,
  TodoLabelRecord[],
}

model TodoLabelRecord {
  name: string;

  //@format("^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$")
  color?: string;
}

union TodoAttachment {
  file: TodoFileAttachment,
  url: TodoUrlAttachment,
}

model TodoUrlAttachment {
  /** A description of the URL */
  description: string;

  /** The url */
  url: url;
}

model TodoFileAttachment {
  /** The todo item this is attached to */
  @visibility("read") todoItemId: TodoItem.id;

  /** The file name of the attachment */
  @maxLength(255)
  filename: string;

  /** The media type of the attachment */
  mediaType: string;

  /** The url where the attachment can be downloaded from */
  @visibility("read") url: url;

  /** The contents of the file */
  @visibility("create") contents: bytes;
}

@error
model ApiError {
  /** A machine readable error code */
  code: string;

  /** A human readable message */
  // https://github.com/microsoft/OpenAPI/blob/main/extensions/x-ms-primary-error-message.md
  @OpenAPI.extension("x-ms-primary-error-message", true)
  message: string;
}

/**
 * Something is wrong with you.
 */
model Standard4XXResponse extends ApiError {
  @minValue(400)
  @maxValue(499)
  @statusCode
  statusCode: int32;
}

/**
 * Something is wrong with me.
 */
model Standard5XXResponse extends ApiError {
  @minValue(500)
  @maxValue(599)
  @statusCode
  statusCode: int32;
}

alias WithStandardErrors<T> = T | Standard4XXResponse | Standard5XXResponse;

namespace Users {
  // would prefer to extend
  // https://github.com/microsoft/typespec/issues/2922

  model UserCreatedResponse {
    ...User;
    ...OkResponse;

    /** The token to use to construct the validate email address url */
    token: string;
  }

  /** The user already exists */
  model UserExistsResponse extends ApiError {
    ...ConflictResponse;
  }

  /** The user is invalid (e.g. forgot to enter email address) */
  model InvalidUserResponse extends ApiError {
    @statusCode statusCode: 422;
  }

  @route("/users")
  @post
  op create(
    user: User,
  ): WithStandardErrors<UserCreatedResponse | UserExistsResponse | InvalidUserResponse>;

  @route("validate")
  @get
  op validate(
    @query token: string,
  ): WithStandardErrors<NoContentResponse | InvalidUserResponse>;

  @route("login")
  @post
  op login(
    username: User.username,
    password: User.password,
  ): WithStandardErrors<NoContentResponse | UnauthorizedResponse>;

  @route("logout")
  @get
  op logout(): OkResponse;

  /** Sends a reset token to the user's email address */
  @route("forgot-password")
  @post
  op forgotPassword(
    email: User.email,
  ): WithStandardErrors<NoContentResponse | NotFoundResponse>;

  @route("reset-password")
  @get
  op resetPassword(
    @query resetToken: string,
  ): WithStandardErrors<NoContentResponse | NotFoundResponse>;
}

@route("items")
namespace TodoItems {
  model PaginationControls {
    /** The limit to the number of items */
    @query limit: int32 = 50;

    /** The offset to start paginating at */
    @query offset: int32 = 0;
  }

  model TodoPage {
    /** The items in the page */
    items: TodoItem[];

    pagination: {
      /** The number of items returned in this page */
      pageSize: int32;

      /** The total number of items */
      totalSize: int32;

      ...PaginationControls;

      /** A link to the previous page, if it exists */
      prevLink?: url;

      /** A link to the next page, if it exists */
      nextLink?: url;
    };
  }

  // deeply annoying that I have to copy/paste this...
  model TodoItemPatch {
    /** The item's title */
    title?: TodoItem.title;

    /** User that the todo is assigned to */
    assignedTo?: TodoItem.assignedTo | null;

    /** A longer description of the todo item in markdown format */
    description?: TodoItem.description | null;

    /** The status of the todo item */
    status?: "NotStarted" | "InProgress" | "Completed";
  }

  model InvalidTodoItem extends ApiError {
    @statusCode statusCode: 422;
  }

  @list op list(...PaginationControls): WithStandardErrors<TodoPage>;

  @sharedRoute
  @post
  op createJson(
    @header contentType: "application/json",
    item: TodoItem,
    attachments: TodoAttachment[],
  ): WithStandardErrors<TodoItem | InvalidTodoItem>;

  @sharedRoute
  @post
  op createForm(
    @header contentType: "multipart/form-data",
    item: TodoItem,
    attachments?: (TodoUrlAttachment | bytes)[],
  ): WithStandardErrors<TodoItem | InvalidTodoItem>;

  @get op get(@path id: TodoItem.id): TodoItem | NotFoundResponse;
  @patch op update(
    @header contentType: "application/merge-patch+json",
    @path id: TodoItem.id,
    patch: TodoItemPatch,
  ): TodoItem;
  @delete op delete(
    @path id: TodoItem.id,
  ): WithStandardErrors<NoContentResponse | NotFoundResponse>;

  @route("{itemId}/attachments")
  namespace Attachments {
    @list op list(
      @path itemId: TodoItem.id,
    ): WithStandardErrors<TodoAttachment[] | NotFoundResponse>;

    @sharedRoute
    @post
    op createUrlAttachment(
      @header contentType: "application/json",
      @path itemId: TodoItem.id,
      contents: TodoAttachment,
    ): WithStandardErrors<NoContentResponse | NotFoundResponse>;

    @sharedRoute
    @post
    op createFileAttachment(
      @header contentType: "multipart/form-data",
      @path itemId: TodoItem.id,
      contents: bytes,
    ): WithStandardErrors<NoContentResponse | NotFoundResponse>;

    // disabled: https://github.com/microsoft/typespec/issues/2925
    // @delete op delete(@path itemId: TodoItem.id): OkResponse | NotFoundResponse;
  }
}
